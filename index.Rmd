---
title: "swissguesser leaderboard"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(httr)
library(rlist)
library(jsonlite)
library(readr)
library(stringr)
library(forcats)
library(plotly)

GH_ACCOUNT <- "swissguesser"

fetchGithubData <- function(repo, path) {

  auth <- authenticate(Sys.getenv("PAT"), "")
  
  # Seperate the filename from the directory
  match <- regexpr("^(.*[\\/])", path)
  if (match[1] > 0) {
    dir <- path %>% substring(match[1], attr(match, "match.length"))
    file <- path %>% substring(attr(match, "match.length") + 1, nchar(path))
  } else {
    dir <- ""
    file <- path
  }

  # To handle files larger than 1MB, use this trick:
  # https://medium.com/@caludio/how-to-download-large-files-from-github-4863a2dbba3b
  req_meta <-
    content(
      GET(
        paste("https://api.github.com/repos", GH_ACCOUNT, repo, "contents", dir, sep="/"),
        auth
      )
    )

  entry <- req_meta %>% list.filter(name == file)
  sha <- entry[1][[1]]$sha

  # Grab contents, using sha as a reference
  req_blob <- GET(
    paste("https://api.github.com/repos", GH_ACCOUNT, repo, "git/blobs", sha, sep="/"),
    auth
  )

  # Need to decode the contents, which are returned in base64
  d <- content(req_blob)$content %>%
    base64_dec() %>%
    rawToChar()

  return(d)
}


data <- fetchGithubData(GH_ACCOUNT, "leaderboard.csv")
df <- read_csv(data,
               col_types = cols_only(user_name = col_character(),
                                     user_handle = col_character(),
                                     user_id = col_character(),
                                     score = col_integer()))


df$user_handle <- as.factor(str_c("@", df$user_handle))
df$user_handle <- fct_reorder(df$user_handle, df$score, max, desc=TRUE)

```


This is an R Markdown format used for publishing markdown documents to GitHub. When you click the **Knit** button all R code chunks are run and a markdown file (.md) suitable for publishing to GitHub is generated.

## Including Code

You can include R code in the document as follows:

```{r cars}
fig <- plot_ly(
  y = df$user_handle,
  x = df$score,
  name = "@swissguesser Leaderboard",
  type = "bar",
  orientation = "h"
)

fig

```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
